<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class VerificaLogin extends CI_Controller {	function __construct(){	   parent::__construct();	   $this->load->model('user','',TRUE);	   $this->load->model('infracao_model','',TRUE);	   $this->load->model('licenca_model','',TRUE);	   $this->load->model('contratante','',TRUE);	   $this->load->model('imovel_model','',TRUE);	   $this->load->library('session');	   $this->load->library('form_validation');	   $this->load->helper('url');	 		session_start();	   	}		public function index(){			$cnpj = $this->input->post('cnpj');			$senha = $this->input->post('senha');			$email_usuario = $this->input->post('email_usuario');		//query the database				$contratante = $this->contratante->buscarId($cnpj);			if($contratante){			$contratante[0]->id;			$empresa = $contratante[0]->nome_empresa;			$result = $this->user->login($email_usuario, $senha,$contratante[0]->id);						if($result){							$totalLicencaVencida = $this->licenca_model->licencasVencidas($contratante[0]->id);				$totalLicencaAVencer = $this->licenca_model->licencasAVencer($contratante[0]->id);				$totalInfracaoParada = $this->infracao_model->infracaoParada($contratante[0]->id);				$menu = $this->imovel_model->menuOrdemAlfabetica();				$sess_array = array();				foreach($result as $row){					$visitante = $this->user->perfil_visitante($row->id);					// $modulos = $this->user->perfil($row->id,1);					// $modulosFilho = $this->user->perfil($row->id,0);					// $visitante = $this->user->perfil_visitante($row->id);					// //$perfilGrafico = $this->user->perfil_grafico($row->id);					// if(!$modulos){						// $this->session->set_flashdata('mensagem','Você digitou algo errado, ou não tem acesso ao sistema');						// redirect('/login', 'refresh');						// }else{						   // $sess_array = array(						 // 'id' => $row->id,						 // 'id_contratante' => $contratante[0]->id,						 // 'visitante' => $visitante[0]['visitante'],						 // 'email' => $row->email,						 // 'empresa' => $empresa,						 // 'perfil' => $modulos,						 // 'perfilFilho' => $modulosFilho,						 // 'menu' => $menu,						 // 'primeiro_acesso' => $row->primeiro_acesso,						  // 'adm' => $row->perfil,					   // );					   // $this->online($row->id);					   // $_SESSION['loginTeste'] = $sess_array;					   // redirect('home/mapa', 'refresh');					// }   					 $sess_array = array(						 'id' => $row->id,						 'id_contratante' => $contratante[0]->id,						 'visitante' => $visitante[0]['visitante'],						 'email' => $row->email,						 'empresa' => $empresa,						 'perfil' => '',						 'perfilFilho' => '',						 'menu' => $menu,						 'primeiro_acesso' => $row->primeiro_acesso,						 'adm' => $row->perfil,						 'tipo_cnd' => 1,					   );					   $this->online($row->id);					   $_SESSION['loginTeste'] = $sess_array;					   redirect('home/mapa', 'refresh');				 }				 return TRUE;			 }else{				$this->session->set_flashdata('mensagem','Você digitou algo errado, ou não tem acesso ao sistema');				redirect('/login', 'refresh');							 }		}else{			$this->session->set_flashdata('mensagem','CNPJ não existe');			redirect('/login', 'refresh');		}		//$result = $this->user->login($username, $password);			}		public function online($id){		$hoje = date("Y-m-d 00:00:01");		$ontem = date('Y-m-d 00:01:01', strtotime('-1 days'));		$result = $this->user->delete_user_online($hoje,$ontem);				$res = $this->user->verify_user_online($id);					   		$dados = array(			'id_usuario'=>$id,			'ip' => $_SERVER['REMOTE_ADDR']			);		$this->user->update_user_online($dados,$id,0);					// if($res){						// $dados = array(				// 'data' => $agora,				// 'ip' => $_SERVER['REMOTE_ADDR']			// );		  			// $this->user->update_user_online($dados,$id,1);					// }else{						// $dados = array(			// 'id_usuario'=>$id,			// 'data' => $agora,			// 'ip' => $_SERVER['REMOTE_ADDR']			// );			// $this->user->update_user_online($dados,$id,0);		// }					}	}